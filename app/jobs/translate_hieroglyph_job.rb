class TranslateHieroglyphJob < ApplicationJob
  queue_as :default

  def perform(post_id)
    post = Post.find_by(id: post_id)
    return unless post.present?
    return if post.translated_text.present?

    translate(post.body)
    post.update(translated_text: translate(post.body))
  end

  private

  def translate(hierogliph)
    client = OpenAI::Client.new(access_token: Rails.application.credentials.dig(:openai, :api_key))
    response = client.chat(
      parameters: {
        model: "o3-mini",
        messages: [{ role: "user", content: prompt(hierogliph)}]
      }
    )
    translated_json = response.dig("choices", 0, "message", "content")
    JSON.parse(translated_json.gsub('```', '').gsub('json', '').gsub(/[\r\n]/,""))["most"]
  end

  def prompt(input)
    <<~PROMPT
      ã‚ãªãŸã¯ãƒ’ã‚¨ãƒ­ã‚°ãƒªãƒ•ç¿»è¨³ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã¨å¯¾å¿œè¡¨ã«å¾“ã„ã€å…¥åŠ›ã•ã‚ŒãŸãƒ’ã‚¨ãƒ­ã‚°ãƒªãƒ•åˆ—ã‚’ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆè¡¨è¨˜ã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚ãªãŠã€å„ãƒ’ã‚¨ãƒ­ã‚°ãƒªãƒ•ã‚·ãƒ³ãƒœãƒ«ã¯ã€å¯¾å¿œè¡¨ã«åŸºã¥ã„ã¦å€™è£œã¨ãªã‚‹ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã¸å¤‰æ›ã•ã‚Œã€å…¨çµ„ã¿åˆã‚ã›ã‚’ç”Ÿæˆã—ãŸä¸Šã§ã€æ„å‘³ãŒé€šã‚Šã‚„ã™ã•ï¼ˆä¾‹ï¼šè‹±èªžã¾ãŸã¯æ—¥æœ¬èªžã¨ã—ã¦ã®è‡ªç„¶ã•ã€æ—¢çŸ¥ã®å›ºæœ‰åè©žã‚„ãƒ–ãƒ©ãƒ³ãƒ‰ã€ä¸€èˆ¬çš„ãªè¡¨ç¾ã¨ã®ä¸€è‡´åº¦ãªã©ï¼‰ã«ã‚ˆã‚Šå„å€™è£œã«ã‚¹ã‚³ã‚¢ä»˜ã‘ã‚’è¡Œã„ã¾ã™ã€‚ãã—ã¦ã€ã‚¹ã‚³ã‚¢ã®é«˜ã„ä¸Šä½3ä»¶ã®å€™è£œã‚’é¸å®šã—ã€æœ€ã‚‚é«˜ã„å€™è£œã‚’ "most"ã€2ç•ªç›®ã‚’ "better"ã€3ç•ªç›®ã‚’ "Good" ã¨ã—ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
      ã€å¯¾å¿œè¡¨ã€‘
      ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ:
      A ð“„¿ 1313F; B ð“ƒ€ 130C0; C ð“Ž¡ 133A1; D ð“‚§ 130A7; E ð“‡‹ 131CB; F ð“†‘ 13191; G ð“Ž¼ 133BC; H ð“Ž› 1339B; I ð“‡‹ 131CB; J ð“†“ 13193; K ð“Ž¡ 133A1; L ð“ƒ­ 130ED; M ð“…“ 13153; N ð“ˆ– 13216; O ð“¯ 1336F; P ð“¤ 133E4; Q ð“˜ 133D8; R ð“‚‹ 1308B; S ð“‹´ 132F4; T ð“ 133CF; U ð“…± 13171; V ð“†‘ 13191; W ð“…± 13171; X ð“Ž¡ð“‹´ 133A1 132F4; Y ð“‡‹ 131CB; Z ð“Šƒ 13283.
      ã€å‡¦ç†æ‰‹é †ã€‘
      1. å€™è£œç”Ÿæˆ - å…¥åŠ›ã•ã‚ŒãŸå„ãƒ’ã‚¨ãƒ­ã‚°ãƒªãƒ•ã‚·ãƒ³ãƒœãƒ«ã«ã¤ã„ã¦ã€ä¸Šè¨˜å¯¾å¿œè¡¨ã‚’å‚ç…§ã—ã€å¯¾å¿œã™ã‚‹ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆå€™è£œãƒªã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹ï¼ˆä¾‹: ã‚ã‚‹ã‚·ãƒ³ãƒœãƒ«ãŒ "131CB" ã¾ãŸã¯ "ð“‡‹" ã«å¯¾å¿œã—ã¦ã„ã‚‹å ´åˆã€è©²å½“ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã¯ Iã€Eã€Y ã®ã„ãšã‚Œã‹ã¨ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ï¼‰ã€‚
      2. å…¨çµ„ã¿åˆã‚ã›ã®ç”Ÿæˆ - å„ä½ç½®ã®å€™è£œã‹ã‚‰å…¨ã¦ã®çµ„ã¿åˆã‚ã›ï¼ˆå¯èƒ½ãªå…¨å¤‰æ›ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰ã‚’ç”Ÿæˆã™ã‚‹ã€‚
      3. è©•ä¾¡ã¨ã‚¹ã‚³ã‚¢ä»˜ã‘ - ç”Ÿæˆã—ãŸå„å€™è£œãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾ã—ã€è‹±èªžã¾ãŸã¯æ—¥æœ¬èªžã¨ã—ã¦æ„å‘³ãŒé€šã‚Šã‚„ã™ã„ã‹ã€æ—¢çŸ¥ã®å›ºæœ‰åè©žã‚„ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ˆä¾‹: NEGICHANã€RUNTEQï¼‰ã¨ã®é¡žä¼¼æ€§ã€ä¸€èˆ¬çš„ãªè¡¨ç¾ï¼ˆä¾‹: GOOD MORNINGï¼‰ã¨ã®ä¸€è‡´åº¦ãªã©ã®è¦³ç‚¹ã§ã‚¹ã‚³ã‚¢ä»˜ã‘ã‚’è¡Œã†ã€‚
      4. ä¸Šä½3ä»¶ã®å‡ºåŠ› - ã‚¹ã‚³ã‚¢ã®æœ€ã‚‚é«˜ã„ã‚‚ã®ã‚’ "most"ã¨ã—ã¦å‡ºåŠ›ã™ã‚‹ã€‚
      ã€å‡ºåŠ›å½¢å¼ã€‘
      å‡ºåŠ›ã¯ä¸‹è¨˜ã®JSONå½¢å¼ã¨ã—ã€ä½™è¨ˆãªæ–‡ç« ã‚„èª¬æ˜Žã¯ä¸€åˆ‡å«ã‚ãšã€åŽ³å¯†ãªJSONã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„:
      {
        "most": "æœ€ä¸Šä½å€™è£œã®å¤‰æ›çµæžœ"
      }.
      ã€æ—¢çŸ¥ã®æ­£è§£ä¾‹ã€‘
      - ãƒ’ã‚¨ãƒ­ã‚°ãƒªãƒ•: ð“ˆ–ð“‡‹ð“Ž¼ð“‡‹ð“Ž¡ð“Ž›ð“„¿ð“ˆ– â†’ æ­£è§£: "NEGICHAN";
      - ãƒ’ã‚¨ãƒ­ã‚°ãƒªãƒ•: ð“‚‹ð“…±ð“ˆ–ð“ð“‡‹ð“˜ â†’ æ­£è§£: "RUNTEQ";
      - ãƒ’ã‚¨ãƒ­ã‚°ãƒªãƒ•: ð“Ž¼ð“¯ð“¯ð“‚§ ð“…“ð“¯ð“‚‹ð“ˆ–ð“‡‹ð“ˆ–ð“Ž¼ â†’ æ­£è§£: "GOOD MORNING".
      ã€å…¥åŠ›ä¾‹ã€‘
      ï¼ˆå„è¡Œã”ã¨ã«åˆ¥ã€…ã®ãƒ’ã‚¨ãƒ­ã‚°ãƒªãƒ•åˆ—ãŒå…¥åŠ›ã•ã‚Œã‚‹å ´åˆã€å„å…¥åŠ›ã«å¯¾ã—ã¦ä¸Šè¨˜ã®å‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚ä¾‹: ð“‹´ð“„¿ð“‹´ð“„¿ð“Ž¡ð“‡‹ð“‹´ð“„¿ð“ˆ–ï¼‰ã€‚
      å…¥åŠ›: #{input}
    PROMPT
  end
end
